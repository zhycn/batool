---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Hero from '../components/Hero.astro';
import SearchBox from '../components/SearchBox.astro';
import Category from '../components/Category.astro';
import EmptyState from '../components/EmptyState.astro';
import Footer from '../components/Footer.astro';
import type { Tool } from '../types/tool';
import { CATEGORY_CONFIG, UI_CONFIG, getFuseConfig } from '../types/settings';

// Âä†ËΩΩÂ∑•ÂÖ∑Êï∞ÊçÆ
const toolsData = await import('../../public/tools.json');
const tools: Tool[] = toolsData.default as Tool[];

// Ëé∑ÂèñÊâÄÊúâÂàÜÁ±ªÂπ∂ÁªüËÆ°
const categories = tools.reduce((acc, tool) => {
  const cat = tool.category || CATEGORY_CONFIG.UNCATEGORY_NAME;
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const categoryList = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<Layout title="Batool - Tool Index">
  <div class="min-h-screen bg-base-100 flex flex-col">

    <Header />

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <div class="flex-1 flex flex-col pt-14">

      <!-- Hero Âå∫Âüü + ÊêúÁ¥¢Ê°Ü -->
      <div class="px-4 sm:px-6 pt-10 sm:pt-14 pb-6 sm:pb-8 text-center">
        <Hero />

        <SearchBox />

        <Category categoryList={categoryList} tools={tools} />
      </div>

      <!-- Â∑•ÂÖ∑ÂàóË°® -->
      <div class="flex-1 px-4 sm:px-6">
        <div class="max-w-4xl mx-auto">
          <!-- Áªü‰∏ÄÂ§ñÊ°ÜÂÆπÂô® - Linear È£éÊ†º -->
          <div class="rounded-lg border border-base-content/8 bg-base-100/30 backdrop-blur-sm overflow-hidden mb-5 sm:mb-6">

            <EmptyState />

            <!-- È™®Êû∂Â±è -->
            <ul id="skeleton-state" class="hidden">
            {
              Array.from({ length: 5 }).map(() => (
                <li class="border-b border-base-content/5 last:border-b-0">
                  <div class="flex items-center justify-between gap-4 px-4 sm:px-5 py-3">
                    <div class="flex-1 min-w-0 space-y-2">
                      <div class="skeleton h-4.5 w-32 rounded-md"></div>
                      <div class="skeleton h-3.5 w-full max-w-md rounded-md"></div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                      <div class="skeleton h-6 w-14 rounded-md"></div>
                      <div class="skeleton h-3.5 w-3.5 rounded-sm"></div>
                    </div>
                  </div>
                </li>
              ))
            }
            </ul>

            <!-- Â∑•ÂÖ∑ÂàóË°® -->
            <ul id="tools-list" class="hidden">
              <!-- Áî± JS Âä®ÊÄÅÊ∏≤Êüì -->
            </ul>
          </div>
        </div>

        <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
        <div id="loading-container" class="my-5 sm:my-6">
          <div id="loading-sentinel" class="min-h-[60px] flex items-center justify-center">
            <span id="loading-spinner" class="loading loading-spinner loading-sm text-base-content/30 hidden"></span>
            <div id="end-message" class="hidden text-center text-base-content/25 text-xs cursor-pointer hover:text-base-content/40 transition-colors" title="ÁÇπÂáªËÅöÁÑ¶ÊêúÁ¥¢Ê°Ü">
              <span id="total-count">Â∑≤Âä†ËΩΩÂÖ®ÈÉ® 0 Êù°Êï∞ÊçÆ</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <Footer />

  </div>

  <!-- ÊúçÂä°Á´ØÊï∞ÊçÆ‰º†ÈÄíÂà∞ÂÆ¢Êà∑Á´Ø -->
  <script define:vars={{ tools, uiConfig: UI_CONFIG, searchConfig: typeof import('../types/settings').SEARCH_CONFIG }}>
    window.__TOOLS__ = tools;
    window.__UI_CONFIG__ = uiConfig;
  </script>

  <!-- ÂÆ¢Êà∑Á´ØËÑöÊú¨ -->
  <script>
    import { debounce } from '../utils/debounce';

    // ‰ªéÂÖ®Â±ÄÂèòÈáèËé∑ÂèñÂ∑•ÂÖ∑Êï∞ÊçÆÂíåÈÖçÁΩÆ
    const toolsData = window.__TOOLS__ || [];
    const uiConfig = window.__UI_CONFIG__ || {
      ITEMS_PER_PAGE: 20,
      DEFAULT_THEME: 'light',
      DEBOUNCE_DELAY: 300,
      SHORTCUTS: { SEARCH: { key: 'k', requiresMeta: true }, ESCAPE: 'Escape' },
      LARGE_DATA_THRESHOLD: 200,
      PLACEHOLDERS: { SEARCH: 'ÊêúÁ¥¢Â∑•ÂÖ∑...', EMPTY_STATE: 'Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÂ∑•ÂÖ∑' },
      INITIAL_LOAD_DELAY: 300,
      OBSERVER: { ROOT_MARGIN: '100px', THRESHOLD: 0.1 },
      ANIMATION: { STAGGER_DELAY: 15, FADE_IN_DURATION: 200, INITIAL_TRANSLATE_Y: 6 }
    };

    const searchConfig = {
      FUSE_WEIGHTS: { NAME: 2, DESCRIPTION: 1.5, CATEGORY: 1, TAGS: 1.2 },
      FUSE_THRESHOLD: 0.4,
      MIN_MATCH_CHAR_LENGTH: 1,
      IGNORE_LOCATION: true,
      DEBOUNCE_DELAY: 300
    };

    console.log('üì¶ ÊÄªÊï∞ÊçÆÈáè:', toolsData.length);

    // DOM ÂÖÉÁ¥†
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const toolsListEl = document.getElementById('tools-list');
    const emptyStateEl = document.getElementById('empty-state');
    const skeletonStateEl = document.getElementById('skeleton-state');
    const loadingContainer = document.getElementById('loading-container');
    const loadingSentinel = document.getElementById('loading-sentinel');
    const loadingSpinner = document.getElementById('loading-spinner');
    const endMessage = document.getElementById('end-message');
    const totalCountEl = document.getElementById('total-count');
    const categoryButtons = document.querySelectorAll('.category-btn');

    // ÁÆÄÂåñÁöÑÁä∂ÊÄÅ
    let allTools = [];
    let filteredTools = [];
    let displayedCount = 0;
    let isLoading = false;
    let observer = null;

    // ÊêúÁ¥¢ÂíåÁ≠õÈÄâÁä∂ÊÄÅ
    let currentCategory = 'all';
    let searchQuery = '';
    let fuse = null;

    // ‰∏ªÈ¢òÂàáÊç¢
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || uiConfig.DEFAULT_THEME;
      document.documentElement.setAttribute('data-theme', savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';

      // Èò≤Ê≠¢‰∏ªÈ¢òÂàáÊç¢Êó∂ÁöÑÈó™ÁÉÅ: ‰∏¥Êó∂Á¶ÅÁî®ËøáÊ∏°Âä®Áîª
      const style = document.createElement('style');
      style.innerHTML = `
        *, *::before, *::after {
          transition: none !important;
        }
      `;
      document.head.appendChild(style);

      // Âº∫Âà∂ÊµèËßàÂô®ÈáçÊéí
      document.documentElement.offsetHeight;

      // ÂàáÊç¢‰∏ªÈ¢ò
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);

      // ‰ΩøÁî® requestAnimationFrame Á°Æ‰øù‰∏ªÈ¢òÂàáÊç¢ÂÆåÊàêÂêéÂÜçÁßªÈô§Ê†∑Âºè
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          document.head.removeChild(style);
        });
      });
    }

    window.toggleTheme = toggleTheme;

    // ÂàùÂßãÂåñ Fuse.js
    async function initFuse() {
      const { default: Fuse } = await import('fuse.js');

      fuse = new Fuse(toolsData, {
        keys: [
          { name: 'name', weight: searchConfig.FUSE_WEIGHTS.NAME },
          { name: 'description', weight: searchConfig.FUSE_WEIGHTS.DESCRIPTION },
          { name: 'category', weight: searchConfig.FUSE_WEIGHTS.CATEGORY },
          { name: 'tags', weight: searchConfig.FUSE_WEIGHTS.TAGS }
        ],
        threshold: searchConfig.FUSE_THRESHOLD,
        includeScore: false,
        shouldSort: true,
        minMatchCharLength: searchConfig.MIN_MATCH_CHAR_LENGTH,
        ignoreLocation: searchConfig.IGNORE_LOCATION
      });

      allTools = toolsData;
      filteredTools = filterTools();
      console.log('üîç Á≠õÈÄâÂêéÊï∞ÊçÆÈáè:', filteredTools.length);

      initObserver();
      loadNextPage();
    }

    // ËøáÊª§Â∑•ÂÖ∑
    function filterTools() {
      let filtered = allTools;

      if (currentCategory !== 'all') {
        filtered = filtered.filter(tool => tool.category === currentCategory);
      }

      if (searchQuery.trim() && fuse) {
        const results = fuse.search(searchQuery);
        filtered = filtered.filter(tool =>
          results.some(r => r.item === tool)
        );
      }

      return filtered;
    }

    // ÂàùÂßãÂåñ Observer
    function initObserver() {
      if (observer) {
        observer.disconnect();
      }

      observer = new IntersectionObserver(
        (entries) => {
          if (entries[0].isIntersecting && !isLoading) {
            loadNextPage();
          }
        },
        {
          rootMargin: uiConfig.OBSERVER.ROOT_MARGIN,
          threshold: uiConfig.OBSERVER.THRESHOLD
        }
      );

      if (loadingSentinel) {
        observer.observe(loadingSentinel);
      }
    }

    // Âä†ËΩΩ‰∏ã‰∏ÄÈ°µ
    function loadNextPage() {
      if (isLoading) {
        return;
      }

      if (displayedCount >= filteredTools.length) {
        showEndState();
        return;
      }

      isLoading = true;

      // ÈöêËóèÈ™®Êû∂Â±è
      if (skeletonStateEl) {
        skeletonStateEl.classList.add('hidden');
      }
      toolsListEl.classList.remove('hidden');

      const start = displayedCount;
      const end = Math.min(start + uiConfig.ITEMS_PER_PAGE, filteredTools.length);
      const newItems = filteredTools.slice(start, end);

      renderTools(newItems, displayedCount === 0);

      displayedCount = end;
      isLoading = false;

      if (displayedCount >= filteredTools.length) {
        showEndState();
        if (observer) observer.disconnect();
      }
    }

    // ÊòæÁ§∫Â∑≤Âä†ËΩΩÂÖ®ÈÉ®Áä∂ÊÄÅ
    function showEndState() {
      loadingSpinner.classList.add('hidden');

      // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÔºå‰∏çÊòæÁ§∫Ê∂àÊÅØ
      if (displayedCount === 0) {
        endMessage.classList.add('hidden');
        return;
      }

      // Â¶ÇÊûúÊï∞ÊçÆÈáè‚â•ÈòàÂÄºÔºåÊèêÁ§∫Áî®Êà∑ÊêúÁ¥¢
      if (displayedCount >= uiConfig.LARGE_DATA_THRESHOLD) {
        endMessage.classList.remove('hidden');
        totalCountEl.innerHTML = `Êï∞ÊçÆËøáÂ§öÔºåÂª∫ËÆÆ‰ΩøÁî®ÊêúÁ¥¢ÂäüËÉΩÁ≤æÁ°ÆÂÆö‰Ωç`;
        totalCountEl.parentElement.style.cursor = 'pointer';
        totalCountEl.parentElement.onclick = () => {
          searchInput.focus();
          searchInput.select();
        };
      } else {
        // Ê≠£Â∏∏ÊòæÁ§∫"Â∑≤Âä†ËΩΩÂÖ®ÈÉ®"Ê∂àÊÅØ
        endMessage.classList.remove('hidden');
        totalCountEl.textContent = `Â∑≤Âä†ËΩΩÂÖ®ÈÉ® ${displayedCount} Êù°Êï∞ÊçÆ`;
        totalCountEl.parentElement.style.cursor = 'default';
        totalCountEl.parentElement.onclick = null;
      }
    }

    // ÈáçÁΩÆÂä†ËΩΩÁä∂ÊÄÅ
    function resetLoading() {
      displayedCount = 0;
      isLoading = false;

      toolsListEl.innerHTML = '';

      // ÂÖàËøáÊª§Êï∞ÊçÆ
      filteredTools = filterTools();
      console.log('üîÑ ÈáçÁΩÆÂä†ËΩΩ,Á≠õÈÄâÂêé:', filteredTools.length, 'Êù°');

      initObserver();

      // Â¶ÇÊûúÁªìÊûú‰∏∫Á©∫ÔºåÁõ¥Êé•ÊòæÁ§∫Á©∫Áä∂ÊÄÅÔºå‰∏çÊòæÁ§∫È™®Êû∂Â±èÔºåÈöêËóèÂä†ËΩΩÂÆπÂô®
      if (filteredTools.length === 0) {
        if (skeletonStateEl) {
          skeletonStateEl.classList.add('hidden');
        }
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        loadingContainer.classList.add('hidden');  // Á©∫Áä∂ÊÄÅÊó∂ÈöêËóèÂä†ËΩΩÂÆπÂô®
      } else {
        // ÊúâÊï∞ÊçÆÊó∂ÔºåÊòæÁ§∫È™®Êû∂Â±èÂπ∂Âª∂ËøüÂä†ËΩΩ
        if (skeletonStateEl) {
          skeletonStateEl.classList.remove('hidden');
        }
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.add('hidden');
        loadingContainer.classList.remove('hidden');  // ÊòæÁ§∫Âä†ËΩΩÂÆπÂô®‰ª•ÊîØÊåÅÊªöÂä®

        setTimeout(() => {
          loadNextPage();
        }, uiConfig.INITIAL_LOAD_DELAY);
      }
    }

    // Ê∏≤ÊüìÂ∑•ÂÖ∑ÂàóË°® - Linear È£éÊ†º
    function renderTools(tools, isFirstPage) {
      // ÈöêËóèÈ™®Êû∂Â±è
      if (skeletonStateEl) {
        skeletonStateEl.classList.add('hidden');
      }

      // Á©∫Áä∂ÊÄÅÂ§ÑÁêÜ
      if (tools.length === 0) {
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        return;
      }

      // ÊúâÊï∞ÊçÆÊó∂ÊòæÁ§∫ÂàóË°®ÔºåÈöêËóèÁ©∫Áä∂ÊÄÅ
      toolsListEl.classList.remove('hidden');
      emptyStateEl.classList.add('hidden');

      const fragment = document.createDocumentFragment();

      tools.forEach((tool, index) => {
        const li = document.createElement('li');
        li.className = 'tool-item border-b border-base-content/5 last:border-b-0';

        const link = document.createElement('a');
        link.href = tool.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        // Linear È£éÊ†ºÔºöÂæÆÂ¶ô hover ÊïàÊûú
        link.className = 'flex items-center justify-between gap-3 sm:gap-4 px-4 sm:px-5 py-3 hover:bg-base-content/[0.02] active:bg-base-content/[0.04] transition-colors duration-150';

        if (isFirstPage) {
          link.style.opacity = '0';
          link.style.transform = `translateY(${uiConfig.ANIMATION.INITIAL_TRANSLATE_Y}px)`;
          link.style.transition = `opacity ${uiConfig.ANIMATION.FADE_IN_DURATION}ms ease-out ${index * uiConfig.ANIMATION.STAGGER_DELAY}ms, transform ${uiConfig.ANIMATION.FADE_IN_DURATION}ms ease-out ${index * uiConfig.ANIMATION.STAGGER_DELAY}ms`;
        }

        link.innerHTML = `
          <div class="flex items-center justify-between gap-3 sm:gap-4 w-full">
            <div class="flex-1 min-w-0">
              <div class="text-sm font-medium text-base-content/90 mb-0.5 truncate">
                ${tool.name}
              </div>
              <div class="text-xs text-base-content/35 truncate hidden sm:block">
                ${tool.description}
              </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-2.5 flex-shrink-0">
              <span class="px-2 py-1 rounded text-xs font-medium bg-base-content/4 text-base-content/40 whitespace-nowrap border border-base-content/4">
                ${tool.category || 'Êú™ÂàÜÁ±ª'}
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-base-content/15 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </div>
        `;

        li.appendChild(link);
        fragment.appendChild(li);
      });

      toolsListEl.appendChild(fragment);

      if (isFirstPage) {
        requestAnimationFrame(() => {
          const items = toolsListEl.querySelectorAll('.tool-item a');
          items.forEach(item => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          });
        });
      }
    }

    // Êõ¥Êñ∞ÂàÜÁ±ªÊåâÈíÆÁä∂ÊÄÅ - Linear È£éÊ†º
    function updateCategoryButtons() {
      categoryButtons.forEach(btn => {
        const category = btn.getAttribute('data-category');
        if (category === currentCategory) {
          btn.className = 'category-btn px-3.5 py-1.5 rounded-md bg-base-content text-base-100 text-xs font-medium hover:opacity-90 transition-opacity';
        } else {
          btn.className = 'category-btn px-3.5 py-1.5 rounded-md bg-base-content/5 text-base-content/70 text-xs font-medium hover:bg-base-content/8 hover:text-base-content transition-all border border-base-content/5';
        }
      });
    }

    // ÊêúÁ¥¢ËæìÂÖ•Â§ÑÁêÜ
    searchInput.addEventListener('input', debounce((e) => {
      const value = e.target.value;
      console.log('üîé ÊêúÁ¥¢:', value);
      searchQuery = value;

      // ÊéßÂà∂Ê∏ÖÈô§ÊåâÈíÆÊòæÁ§∫
      if (value.length > 0) {
        clearSearchBtn.classList.remove('hidden');
      } else {
        clearSearchBtn.classList.add('hidden');
      }

      resetLoading();
    }, searchConfig.DEBOUNCE_DELAY));

    // Ê∏ÖÈô§ÊåâÈíÆÁÇπÂáªÂ§ÑÁêÜ
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchQuery = '';
      clearSearchBtn.classList.add('hidden');
      searchInput.focus();
      resetLoading();
    });

    // ÂàÜÁ±ªÊåâÈíÆÁÇπÂáªÂ§ÑÁêÜ
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        console.log('üè∑Ô∏è  ÂàÜÁ±ª:', btn.getAttribute('data-category'));
        currentCategory = btn.getAttribute('data-category') || 'all';
        updateCategoryButtons();
        resetLoading();
      });
    });

    // Âø´Êç∑ÈîÆÊîØÊåÅ
    document.addEventListener('keydown', (e) => {
      // ÊêúÁ¥¢Âø´Êç∑ÈîÆ (‚åòK / Ctrl+K)
      if (uiConfig.SHORTCUTS.SEARCH.requiresMeta && (e.metaKey || e.ctrlKey) && e.key === uiConfig.SHORTCUTS.SEARCH.key) {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
      // Escape Ê∏ÖÈô§ÊêúÁ¥¢
      if (e.key === uiConfig.SHORTCUTS.ESCAPE && document.activeElement === searchInput) {
        searchInput.value = '';
        searchQuery = '';
        clearSearchBtn.classList.add('hidden');
        resetLoading();
        searchInput.blur();
      }
    });

    // È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ
    window.addEventListener('beforeunload', () => {
      if (observer) {
        observer.disconnect();
      }
    });

    // ÂàùÂßãÂåñ
    console.log('üöÄ ÂºÄÂßãÂàùÂßãÂåñ...');
    initTheme();
    initFuse();
  </script>
</Layout>
