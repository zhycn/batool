---
import Layout from '../layouts/Layout.astro';
import type { Tool } from '../types/tool';

// åŠ è½½å·¥å…·æ•°æ®
const toolsData = await import('../../public/tools.json');
const tools: Tool[] = toolsData.default as Tool[];

// è·å–æ‰€æœ‰åˆ†ç±»å¹¶ç»Ÿè®¡
const categories = tools.reduce((acc, tool) => {
  const cat = tool.category || 'æœªåˆ†ç±»';
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const categoryList = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<Layout title="Batool - Tool Index">
  <!-- åŠ¨æ€æ¸å˜èƒŒæ™¯å±‚ -->
  <div class="fixed inset-0 -z-10 overflow-hidden">
    <!-- æ¸å˜å…‰çƒ 1 -->
    <div class="absolute -top-[30%] -left-[10%] w-[50%] h-[50%] rounded-full bg-primary/10 blur-[120px] animate-pulse"></div>
    <!-- æ¸å˜å…‰çƒ 2 -->
    <div class="absolute top-[40%] -right-[10%] w-[40%] h-[40%] rounded-full bg-secondary/10 blur-[100px] animate-pulse" style="animation-delay: 1s;"></div>
    <!-- æ¸å˜å…‰çƒ 3 -->
    <div class="absolute -bottom-[20%] left-[30%] w-[45%] h-[45%] rounded-full bg-accent/10 blur-[110px] animate-pulse" style="animation-delay: 2s;"></div>
  </div>

  <!-- DaisyUI ä¸»é¢˜å®¹å™¨ - Flexbox å¸ƒå±€å®ç° sticky footer -->
  <div class="min-h-screen bg-base-100/80 backdrop-blur-sm flex flex-col">

    <!-- å›ºå®šé¡¶éƒ¨ Header - ç»ç’ƒæ€æ•ˆæœ -->
    <header class="fixed top-0 left-0 right-0 z-50 h-20 bg-base-100/70 backdrop-blur-xl border-b border-base-content/5 shadow-sm transition-all duration-300">
      <div class="h-full px-6 flex items-center justify-between gap-4">
        <!-- å·¦ä¾§: Brand -->
        <div class="flex items-center gap-2 flex-shrink-0">
          <!-- å·¥å…·ç®±å›¾æ ‡ - æ¸å˜æ•ˆæœ -->
          <div class="relative">
            <div class="absolute inset-0 bg-gradient-to-br from-primary to-accent blur-md opacity-40"></div>
            <svg xmlns="http://www.w3.org/2000/svg" class="relative w-7 h-7 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
          <a href="/" class="text-2xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent hover:opacity-80 transition-smooth">
            Batool
          </a>
        </div>

        <!-- ä¸­é—´: æœç´¢æ¡† -->
        <div class="flex-1 flex justify-center max-w-lg mx-auto">
          <div class="relative w-full max-w-md group">
            <!-- æœç´¢æ¡†å…‰æ™•æ•ˆæœ -->
            <div class="absolute inset-0 bg-gradient-to-r from-primary/20 via-accent/20 to-secondary/20 rounded-full blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity duration-500"></div>
            <input
              id="search-input"
              type="text"
              placeholder="æœç´¢å·¥å…·..."
              class="relative input input-bordered input-lg rounded-2xl w-full pr-16 bg-base-100/80 backdrop-blur-sm border-2 border-base-content/10 focus:border-primary/50 focus:ring-4 focus:ring-primary/10 transition-all duration-300 h-12 shadow-sm"
            />
            <div class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-base-content/40 hidden md:block pointer-events-none">
              âŒ˜K
            </div>
          </div>
        </div>

        <!-- å³ä¾§: æ“ä½œæŒ‰é’®ç»„ -->
        <div class="flex items-center gap-3 flex-shrink-0">
          <!-- GitHub æŒ‰é’® -->
          <a
            href="https://github.com"
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-ghost btn-circle hover:bg-base-content/5 hover:scale-110 active:scale-95 transition-all duration-200 group"
            aria-label="GitHub Repository"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 group-hover:text-primary transition-colors" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
            </svg>
          </a>

          <!-- ä¸»é¢˜åˆ‡æ¢å™¨ - dropdown -->
          <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-ghost btn-circle hover:bg-base-content/5 hover:scale-110 active:scale-95 transition-all duration-200">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
              </svg>
            </div>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl shadow-base-content/10 bg-base-100/90 backdrop-blur-xl rounded-2xl w-44 border border-base-content/5">
              <li><a onclick="setTheme('emerald')" class="flex items-center gap-2 rounded-lg hover:bg-base-content/5">
                <span class="w-3 h-3 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 shadow-sm"></span>
                Emerald
              </a></li>
              <li><a onclick="setTheme('winter')" class="flex items-center gap-2 rounded-lg hover:bg-base-content/5">
                <span class="w-3 h-3 rounded-full bg-gradient-to-br from-sky-400 to-sky-600 shadow-sm"></span>
                Winter
              </a></li>
              <li><a onclick="setTheme('light')" class="flex items-center gap-2 rounded-lg hover:bg-base-content/5">
                <span class="w-3 h-3 rounded-full bg-gradient-to-br from-gray-100 to-gray-300 border border-base-content/10 shadow-sm"></span>
                Light
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </header>

    <!-- é¡µé¢ä¸»ä½“å®¹å™¨ - å¡«æ»¡å‰©ä½™é«˜åº¦ -->
    <div class="flex-1 flex flex-col pt-20">

      <!-- ä¸»å†…å®¹åŒº -->
      <div class="flex-1 max-w-6xl mx-auto px-4 py-12">

      <!-- Hero åŒºåŸŸ - ç²¾è‡´æ ‡é¢˜ -->
      <div class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">
          <span class="bg-gradient-to-r from-primary via-accent to-secondary bg-clip-text text-transparent bg-[length:200%_auto] animate-gradient">
            å‘ç°ä½ çš„å·¥å…·é›†
          </span>
        </h1>
        <p class="text-base-content/60 text-lg">
          ç²¾é€‰å·¥å…·ç´¢å¼• Â· å¿«é€Ÿæœç´¢ Â· å³æ—¶è®¿é—®
        </p>
      </div>

      <!-- åˆ†ç±»è¿‡æ»¤å™¨ - ç°ä»£èƒ¶å›Šæ ·å¼ -->
      <div class="mb-12">
        <div class="flex flex-wrap justify-center gap-3">
          <button
            data-category="all"
            class="category-btn px-5 py-2.5 rounded-full bg-gradient-to-r from-primary to-accent text-base-100 font-medium shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 hover:scale-105 active:scale-95 transition-all duration-200 cursor-pointer"
          >
            å…¨éƒ¨ <span class="ml-2 opacity-80">({tools.length})</span>
          </button>
          {
            categoryList.map(([cat, count]) => (
              <button
                data-category={cat}
                class="category-btn px-5 py-2.5 rounded-full bg-base-100 border-2 border-base-content/10 hover:border-primary/50 hover:bg-primary/5 font-medium hover:scale-105 active:scale-95 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md"
              >
                {cat} <span class="ml-2 text-base-content/50">({count})</span>
              </button>
            ))
          }
        </div>
      </div>

      <!-- å·¥å…·åˆ—è¡¨ - å¡ç‰‡åŒ–è®¾è®¡ -->
      <div id="tools-container">
        <!-- ç©ºçŠ¶æ€ - ç°ä»£è®¾è®¡ -->
        <div id="empty-state" class="hidden text-center py-20">
          <div class="text-7xl mb-6 opacity-50">ğŸ”</div>
          <h3 class="text-2xl font-semibold mb-3 text-base-content/80">æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·</h3>
          <p class="text-base-content/50">å°è¯•è°ƒæ•´æœç´¢è¯æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»</p>
        </div>

        <!-- å·¥å…·å¡ç‰‡åˆ—è¡¨ - ç½‘æ ¼å¸ƒå±€ -->
        <div id="tools-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- ç”± JS åŠ¨æ€æ¸²æŸ“ -->
        </div>

        <!-- åŠ è½½çŠ¶æ€å’Œå“¨å…µå…ƒç´  -->
        <div id="loading-container" class="py-8">
          <!-- å“¨å…µå…ƒç´  - å§‹ç»ˆå¯è§,è®© Observer ç›‘å¬ -->
          <div id="loading-sentinel" class="min-h-[60px] flex items-center justify-center">
            <!-- åŠ è½½ spinner - å¯ä»¥éšè— -->
            <span id="loading-spinner" class="loading loading-spinner loading-primary"></span>
            <!-- å·²åŠ è½½å…¨éƒ¨æ¶ˆæ¯ -->
            <div id="end-message" class="hidden text-center text-base-content/40 text-sm font-medium">
              âœ¨ å·²åŠ è½½å…¨éƒ¨ <span id="total-count">0</span> æ¡æ•°æ®
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Footer - ç°ä»£ç»ç’ƒæ€ -->
    <footer class="py-8 border-t border-base-content/5 bg-base-100/50 backdrop-blur-sm">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4 text-sm">
          <!-- å·¦ä¾§: æŠ€æœ¯æ ˆ -->
          <div class="flex items-center gap-2 text-base-content/60">
            <span class="text-base-content/40">Built with</span>
            <a href="https://astro.build" target="_blank" rel="noopener noreferrer" class="link link-hover link-primary font-medium">Astro</a>
            <span class="text-base-content/20">Â·</span>
            <a href="https://daisyui.com" target="_blank" rel="noopener noreferrer" class="link link-hover link-primary font-medium">DaisyUI</a>
            <span class="text-base-content/20">Â·</span>
            <a href="https://tailwindcss.com" target="_blank" rel="noopener noreferrer" class="link link-hover link-primary font-medium">TailwindCSS</a>
          </div>

          <!-- å³ä¾§: ç‰ˆæƒä¿¡æ¯ -->
          <div class="flex items-center gap-4 text-base-content/60">
            <span>Â© 2025 Batool</span>
            <a href="https://github.com" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors" aria-label="GitHub Repository">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </footer>

  </div>

  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®ä¼ é€’åˆ°å®¢æˆ·ç«¯ -->
  <script define:vars={{ tools }}>
    window.__TOOLS__ = tools;
  </script>

  <!-- å®¢æˆ·ç«¯è„šæœ¬ -->
  <script>
    // ä»å…¨å±€å˜é‡è·å–å·¥å…·æ•°æ®
    const toolsData = window.__TOOLS__ || [];
    console.log('ğŸ“¦ æ€»æ•°æ®é‡:', toolsData.length);

    // DOM å…ƒç´ 
    const searchInput = document.getElementById('search-input');
    const toolsListEl = document.getElementById('tools-list');
    const emptyStateEl = document.getElementById('empty-state');
    const loadingSentinel = document.getElementById('loading-sentinel');
    const loadingSpinner = document.getElementById('loading-spinner');
    const endMessage = document.getElementById('end-message');
    const totalCountEl = document.getElementById('total-count');
    const categoryButtons = document.querySelectorAll('.category-btn');

    // é…ç½®
    const ITEMS_PER_PAGE = 15;

    // ç®€åŒ–çš„çŠ¶æ€
    let allTools = [];           // å…¨éƒ¨æ•°æ®
    let filteredTools = [];      // ç­›é€‰åçš„æ•°æ®
    let displayedCount = 0;      // å·²æ˜¾ç¤ºæ•°é‡
    let isLoading = false;       // æ˜¯å¦åŠ è½½ä¸­
    let observer = null;         // Observer å®ä¾‹

    // æœç´¢å’Œç­›é€‰çŠ¶æ€
    let currentCategory = 'all';
    let searchQuery = '';
    let fuse = null;

    // åˆå§‹åŒ–ä¸»é¢˜
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'emerald';
      console.log('ğŸ¨ initTheme - è¯»å–çš„ä¸»é¢˜:', savedTheme);
      console.log('ğŸ¨ è®¾ç½®å‰ document.documentElement:', document.documentElement.getAttribute('data-theme'));

      document.documentElement.setAttribute('data-theme', savedTheme);

      console.log('ğŸ¨ è®¾ç½®å document.documentElement:', document.documentElement.getAttribute('data-theme'));
      console.log('ğŸ¨ å½“å‰é¡µé¢æ‰€æœ‰ data-theme:', document.querySelectorAll('[data-theme]'));
    }

    window.setTheme = function(theme) {
      console.log('ğŸ¨ setTheme è¢«è°ƒç”¨ - åˆ‡æ¢åˆ°ä¸»é¢˜:', theme);
      console.log('ğŸ¨ è®¾ç½®å‰:', document.documentElement.getAttribute('data-theme'));

      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);

      console.log('ğŸ¨ è®¾ç½®å:', document.documentElement.getAttribute('data-theme'));

      // å»¶è¿Ÿæ£€æŸ¥ï¼Œè®© DOM æ›´æ–°
      setTimeout(() => {
        console.log('ğŸ¨ 100ms åçš„ data-theme:', document.documentElement.getAttribute('data-theme'));
      }, 100);
    };

    // åˆå§‹åŒ– Fuse.js
    async function initFuse() {
      const { default: Fuse } = await import('fuse.js');

      fuse = new Fuse(toolsData, {
        keys: [
          { name: 'name', weight: 2 },
          { name: 'description', weight: 1.5 },
          { name: 'category', weight: 1 },
          { name: 'tags', weight: 1.2 }
        ],
        threshold: 0.4,
        includeScore: false,
        shouldSort: true,
        minMatchCharLength: 1,
        ignoreLocation: true
      });

      // åˆå§‹åŒ–æ•°æ®
      allTools = toolsData;
      filteredTools = filterTools();
      console.log('ğŸ” ç­›é€‰åæ•°æ®é‡:', filteredTools.length);

      // åˆå§‹åŠ è½½
      initObserver();
      loadNextPage();
    }

    // è¿‡æ»¤å·¥å…·
    function filterTools() {
      let filtered = allTools;

      if (currentCategory !== 'all') {
        filtered = filtered.filter(tool => tool.category === currentCategory);
      }

      if (searchQuery.trim() && fuse) {
        const results = fuse.search(searchQuery);
        filtered = filtered.filter(tool =>
          results.some(r => r.item === tool)
        );
      }

      return filtered;
    }

    // åˆå§‹åŒ– Observer
    function initObserver() {
      // å…ˆæ–­å¼€æ—§çš„
      if (observer) {
        observer.disconnect();
      }

      // åˆ›å»ºæ–°çš„ Observer
      observer = new IntersectionObserver(
        (entries) => {
          console.log('ğŸ‘€ Observer è§¦å‘', entries[0].isIntersecting);

          if (entries[0].isIntersecting && !isLoading) {
            console.log('âœ… å¼€å§‹åŠ è½½ä¸‹ä¸€é¡µ');
            loadNextPage();
          }
        },
        {
          rootMargin: '100px',
          threshold: 0.1
        }
      );

      // ç¡®ä¿å…ƒç´ å­˜åœ¨å†è§‚å¯Ÿ
      if (loadingSentinel) {
        observer.observe(loadingSentinel);
        console.log('ğŸ¯ Observer å·²å¯åŠ¨');
      }
    }

    // åŠ è½½ä¸‹ä¸€é¡µ
    function loadNextPage() {
      // é˜²æ­¢é‡å¤åŠ è½½
      if (isLoading) {
        console.log('â¸ï¸  æ­£åœ¨åŠ è½½ä¸­,è·³è¿‡');
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½å…¨éƒ¨
      if (displayedCount >= filteredTools.length) {
        console.log('ğŸ å·²åŠ è½½å…¨éƒ¨æ•°æ®');
        showEndState();
        return;
      }

      console.log(`ğŸ“„ åŠ è½½ç¬¬ ${Math.floor(displayedCount / ITEMS_PER_PAGE) + 1} é¡µ`);
      isLoading = true;

      // æ˜¾ç¤ºåŠ è½½ spinner
      loadingSpinner.classList.remove('hidden');
      endMessage.classList.add('hidden');

      // è®¡ç®—è¦åŠ è½½çš„æ•°æ®
      const start = displayedCount;
      const end = Math.min(start + ITEMS_PER_PAGE, filteredTools.length);
      const newItems = filteredTools.slice(start, end);

      console.log(`ğŸ“¦ åŠ è½½ ${newItems.length} æ¡æ•°æ® (ç¬¬ ${start}-${end} æ¡)`);

      // æ¸²æŸ“æ•°æ®
      renderTools(newItems, displayedCount === 0);

      // æ›´æ–°è®¡æ•°
      displayedCount = end;
      isLoading = false;

      // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
      if (displayedCount >= filteredTools.length) {
        console.log('âœ… å·²åŠ è½½å…¨éƒ¨');
        showEndState();
        if (observer) observer.disconnect();
      } else {
        console.log(`â³ è¿˜æœ‰ ${filteredTools.length - displayedCount} æ¡æ•°æ®`);
        // éšè— spinner,ä½†ä¿æŒ loadingSentinel å¯è§
        loadingSpinner.classList.add('hidden');
      }
    }

    // æ˜¾ç¤ºå·²åŠ è½½å…¨éƒ¨çŠ¶æ€
    function showEndState() {
      loadingSpinner.classList.add('hidden');
      endMessage.classList.remove('hidden');
      totalCountEl.textContent = displayedCount;
    }

    // é‡ç½®åŠ è½½çŠ¶æ€
    function resetLoading() {
      displayedCount = 0;
      isLoading = false;

      toolsListEl.innerHTML = '';
      loadingSpinner.classList.remove('hidden');
      endMessage.classList.add('hidden');

      // é‡æ–°è¿‡æ»¤
      filteredTools = filterTools();
      console.log('ğŸ”„ é‡ç½®åŠ è½½,ç­›é€‰å:', filteredTools.length, 'æ¡');

      // é‡æ–°åˆå§‹åŒ– Observer
      initObserver();

      // ç«‹å³åŠ è½½ç¬¬ä¸€é¡µ
      loadNextPage();
    }

    // æ¸²æŸ“å·¥å…·å¡ç‰‡
    function renderTools(tools, isFirstPage) {
      if (tools.length === 0) {
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        return;
      }

      toolsListEl.classList.remove('hidden');
      emptyStateEl.classList.add('hidden');

      const fragment = document.createDocumentFragment();

      tools.forEach((tool, index) => {
        const card = document.createElement('div');
        card.className = 'tool-card group relative bg-base-100/60 backdrop-blur-sm rounded-2xl p-5 border border-base-content/5 hover:border-primary/20 hover:shadow-xl hover:shadow-primary/10 transition-all duration-300 cursor-pointer hover:-translate-y-1';

        if (isFirstPage) {
          card.style.opacity = '0';
          card.style.transform = 'translateY(16px)';
          card.style.transition = `opacity 0.5s ease-out ${index * 0.05}s, transform 0.5s ease-out ${index * 0.05}s`;
        }

        card.innerHTML = `
          <div class="flex flex-col gap-4">
            <!-- é¡¶éƒ¨: æ ‡é¢˜å’ŒæŒ‰é’® -->
            <div class="flex items-start justify-between gap-3">
              <div class="flex-1 min-w-0">
                <h3 class="text-lg font-bold mb-1 group-hover:text-primary transition-colors">
                  <a href="${tool.url}" target="_blank" rel="noopener noreferrer">${tool.name}</a>
                </h3>
                <p class="text-sm text-base-content/60 line-clamp-2 leading-relaxed">
                  ${tool.description}
                </p>
              </div>
              <a
                href="${tool.url}"
                target="_blank"
                rel="noopener noreferrer"
                class="flex-shrink-0 w-10 h-10 rounded-xl bg-gradient-to-br from-primary/10 to-accent/10 flex items-center justify-center group-hover:from-primary group-hover:to-accent group-hover:text-base-100 transition-all duration-300"
                aria-label="æ‰“å¼€ ${tool.name}"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                </svg>
              </a>
            </div>

            <!-- åº•éƒ¨: æ ‡ç­¾ -->
            <div class="flex flex-wrap gap-2">
              <span class="px-2.5 py-1 rounded-lg bg-primary/10 text-primary text-xs font-medium">${tool.category || 'æœªåˆ†ç±»'}</span>
              ${(tool.tags || []).map(tag =>
                `<span class="px-2.5 py-1 rounded-lg bg-base-content/5 text-base-content/60 text-xs">${tag}</span>`
              ).join('')}
            </div>
          </div>
        `;

        fragment.appendChild(card);
      });

      toolsListEl.appendChild(fragment);

      if (isFirstPage) {
        requestAnimationFrame(() => {
          const cards = toolsListEl.querySelectorAll('.tool-card');
          cards.forEach(card => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
          });
        });
      }
    }

    // æ›´æ–°åˆ†ç±»æŒ‰é’®çŠ¶æ€
    function updateCategoryButtons() {
      categoryButtons.forEach(btn => {
        const category = btn.getAttribute('data-category');
        if (category === currentCategory) {
          // æ¿€æ´»çŠ¶æ€: æ¸å˜èƒŒæ™¯
          btn.className = 'category-btn px-5 py-2.5 rounded-full bg-gradient-to-r from-primary to-accent text-base-100 font-medium shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 hover:scale-105 active:scale-95 transition-all duration-200 cursor-pointer';
        } else {
          // éæ¿€æ´»çŠ¶æ€: ç™½åº•è¾¹æ¡†
          btn.className = 'category-btn px-5 py-2.5 rounded-full bg-base-100 border-2 border-base-content/10 hover:border-primary/50 hover:bg-primary/5 font-medium hover:scale-105 active:scale-95 transition-all duration-200 cursor-pointer shadow-sm hover:shadow-md';
        }
      });
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // æœç´¢è¾“å…¥å¤„ç†
    searchInput.addEventListener('input', debounce((e) => {
      console.log('ğŸ” æœç´¢:', e.target.value);
      searchQuery = e.target.value;
      resetLoading();
    }, 300));

    // åˆ†ç±»æŒ‰é’®ç‚¹å‡»å¤„ç†
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        console.log('ğŸ·ï¸  åˆ†ç±»:', btn.getAttribute('data-category'));
        currentCategory = btn.getAttribute('data-category') || 'all';
        updateCategoryButtons();
        resetLoading();
      });
    });

    // å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
      if (e.key === 'Escape' && document.activeElement === searchInput) {
        searchInput.value = '';
        searchQuery = '';
        resetLoading();
        searchInput.blur();
      }
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (observer) {
        observer.disconnect();
      }
    });

    // æ·»åŠ è‡ªå®šä¹‰æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
      #tools-list {
        scroll-margin-top: 100px;
      }

      /* æ¸å˜èƒŒæ™¯åŠ¨ç”» */
      @keyframes gradient {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
      }

      .animate-gradient {
        background-size: 200% auto;
        animation: gradient 3s ease infinite;
      }

      /* å¹³æ»‘è¿‡æ¸¡ */
      .transition-smooth {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
    `;
    document.head.appendChild(style);

    // åˆå§‹åŒ–
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–...');
    initTheme();
    initFuse();
  </script>
</Layout>
