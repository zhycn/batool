---
import Layout from '../layouts/Layout.astro';
import type { Tool } from '../types/tool';

// åŠ è½½å·¥å…·æ•°æ®
const toolsData = await import('../../public/tools.json');
const tools: Tool[] = toolsData.default as Tool[];

// è·å–æ‰€æœ‰åˆ†ç±»å¹¶ç»Ÿè®¡
const categories = tools.reduce((acc, tool) => {
  const cat = tool.category || 'æœªåˆ†ç±»';
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const categoryList = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<Layout title="Batool - ä¸ªäººå·¥å…·ç´¢å¼•ç«™">
  <div class="min-h-screen bg-base-100">
    <div class="max-w-5xl mx-auto px-4 py-8 md:py-12">

      <!-- Hero åŒº -->
      <header class="text-center mb-10 md:mb-12">
        <div class="inline-block mb-4">
          <span class="text-6xl">ğŸ› ï¸</span>
        </div>
        <h1 class="text-4xl md:text-5xl font-bold bg-gradient-to-r from-primary via-secondary to-accent bg-clip-text text-transparent mb-4">
          Batool
        </h1>
        <p class="text-base md:text-lg text-base-content/70 max-w-2xl mx-auto">
          ä½ çš„ä¸ªäººå·¥å…·ç´¢å¼•ç«™ â€”â€” å¿«é€Ÿæœç´¢ã€ä¸€é”®ç›´è¾¾ï¼Œæ‰€æœ‰å·¥å…·å°½åœ¨æŒæ¡ã€‚
        </p>
        <div class="mt-4 flex justify-center gap-4 text-sm text-base-content/60">
          <span>ğŸ“¦ å…± <strong class="text-primary">{tools.length}</strong> ä¸ªå·¥å…·</span>
          <span>ğŸ·ï¸ <strong class="text-secondary">{categoryList.length}</strong> ä¸ªåˆ†ç±»</span>
        </div>
      </header>

      <!-- æœç´¢ä¸ç­›é€‰åŒº -->
      <div class="mb-8 space-y-4">
        <!-- æœç´¢æ¡† -->
        <div class="relative">
          <label for="search-input" class="sr-only">æœç´¢å·¥å…·</label>
          <div class="relative group">
            <input
              id="search-input"
              type="text"
              placeholder="ğŸ” æœç´¢å·¥å…·åç§°ã€æè¿°æˆ–åˆ†ç±»..."
              class="input input-bordered input-lg w-full pr-16 focus:input-primary transition-all duration-200"
            />
            <span class="absolute right-4 top-1/2 -translate-y-1/2 text-base-content/40 text-sm select-none">
              âŒ˜K
            </span>
          </div>
        </div>

        <!-- åˆ†ç±»ç­›é€‰ -->
        <div class="flex flex-wrap gap-2">
          <button
            data-category="all"
            class="category-btn badge badge-primary cursor-pointer hover:badge-lg transition-all duration-200"
          >
            å…¨éƒ¨ <span class="ml-1 opacity-70">({tools.length})</span>
          </button>
          {
            categoryList.map(([cat, count]) => (
              <button
                data-category={cat}
                class="category-btn badge badge-outline cursor-pointer hover:badge-lg transition-all duration-200"
              >
                {cat} <span class="ml-1 opacity-70">({count})</span>
              </button>
            ))
          }
        </div>
      </div>

      <!-- å·¥å…·åˆ—è¡¨ -->
      <div id="tools-container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading-state" class="hidden text-center py-12">
          <span class="loading loading-spinner loading-lg text-primary"></span>
          <p class="mt-4 text-base-content/60">åŠ è½½ä¸­...</p>
        </div>

        <!-- ç©ºçŠ¶æ€ -->
        <div id="empty-state" class="hidden text-center py-16">
          <div class="text-6xl mb-4">ğŸ”</div>
          <h3 class="text-xl font-semibold mb-2">æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·</h3>
          <p class="text-base-content/60">å°è¯•è°ƒæ•´æœç´¢è¯æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»</p>
        </div>

        <!-- å·¥å…·åˆ—è¡¨ -->
        <div id="tools-list" class="grid gap-4">
          <!-- ç”± JS åŠ¨æ€æ¸²æŸ“ -->
        </div>
      </div>

      <!-- åº•éƒ¨ä¿¡æ¯ -->
      <footer class="mt-16 text-center text-sm text-base-content/50">
        <p>ä½¿ç”¨ â¤ï¸ å’Œ Astro æ„å»º</p>
      </footer>

    </div>
  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®ä¼ é€’åˆ°å®¢æˆ·ç«¯ -->
  <script define:vars={{ tools }}>
    window.__TOOLS__ = tools;
  </script>

  <!-- å®¢æˆ·ç«¯è„šæœ¬ -->
  <script>
    // ä»å…¨å±€å˜é‡è·å–å·¥å…·æ•°æ®
    const toolsData = window.__TOOLS__ || [];

    // DOM å…ƒç´ 
    const searchInput = document.getElementById('search-input');
    const toolsListEl = document.getElementById('tools-list');
    const emptyStateEl = document.getElementById('empty-state');
    const categoryButtons = document.querySelectorAll('.category-btn');

    // çŠ¶æ€
    let currentCategory = 'all';
    let searchQuery = '';
    let fuse = null;

    // åˆå§‹åŒ– Fuse.jsï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰
    async function initFuse() {
      const { default: Fuse } = await import('fuse.js');

      fuse = new Fuse(toolsData, {
        keys: [
          { name: 'name', weight: 2 },
          { name: 'description', weight: 1.5 },
          { name: 'category', weight: 1 },
          { name: 'tags', weight: 1.2 }
        ],
        threshold: 0.4,
        includeScore: false,
        shouldSort: true,
        minMatchCharLength: 1,
        ignoreLocation: true
      });

      // åˆå§‹æ¸²æŸ“
      renderTools(filterTools());
    }

    // è¿‡æ»¤å·¥å…·
    function filterTools() {
      let filtered = toolsData;

      // åˆ†ç±»ç­›é€‰
      if (currentCategory !== 'all') {
        filtered = filtered.filter(tool => tool.category === currentCategory);
      }

      // æœç´¢ç­›é€‰
      if (searchQuery.trim() && fuse) {
        const results = fuse.search(searchQuery);
        filtered = filtered.filter(tool =>
          results.some(r => r.item === tool)
        );
      }

      return filtered;
    }

    // æ¸²æŸ“å·¥å…·å¡ç‰‡
    function renderTools(tools) {
      if (tools.length === 0) {
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        return;
      }

      toolsListEl.classList.remove('hidden');
      emptyStateEl.classList.add('hidden');

      const html = tools.map((tool, index) => `
        <article
          class="card bg-base-200 hover:bg-base-300 transition-all duration-200 shadow-sm hover:shadow-md"
          style="animation: fadeIn 0.3s ease-out ${index * 0.05}s both"
        >
          <div class="card-body p-5">
            <div class="flex flex-col sm:flex-row justify-between gap-4">
              <!-- ä¸»ä¿¡æ¯åŒº -->
              <div class="flex-1 min-w-0">
                <div class="flex items-start gap-3">
                  <div class="flex-1">
                    <h2 class="card-title text-xl mb-2">
                      ${tool.name}
                    </h2>
                    <p class="text-base-content/70 text-sm leading-relaxed">
                      ${tool.description}
                    </p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-3">
                  <span class="badge badge-ghost badge-sm">
                    ${tool.category || 'æœªåˆ†ç±»'}
                  </span>
                  ${(tool.tags || []).map(tag =>
                    `<span class="badge badge-outline badge-sm opacity-70">${tag}</span>`
                  ).join('')}
                </div>
              </div>

              <!-- æ“ä½œåŒº -->
              <div class="flex items-center">
                <a
                  href="${tool.url}"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn btn-primary btn-sm btn-circle group"
                  aria-label="æ‰“å¼€ ${tool.name}"
                  title="æ‰“å¼€ ${tool.name}"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-5 w-5 group-hover:scale-110 transition-transform"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                    <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </article>
      `).join('');

      toolsListEl.innerHTML = html;
    }

    // æ›´æ–°åˆ†ç±»æŒ‰é’®çŠ¶æ€
    function updateCategoryButtons() {
      categoryButtons.forEach(btn => {
        const category = btn.getAttribute('data-category');
        if (category === currentCategory) {
          btn.classList.remove('badge-outline');
          btn.classList.add('badge-primary');
        } else {
          btn.classList.remove('badge-primary');
          btn.classList.add('badge-outline');
        }
      });
    }

    // æœç´¢è¾“å…¥å¤„ç†
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      renderTools(filterTools());
    });

    // åˆ†ç±»æŒ‰é’®ç‚¹å‡»å¤„ç†
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        currentCategory = btn.getAttribute('data-category') || 'all';
        updateCategoryButtons();
        renderTools(filterTools());

        // æ»šåŠ¨åˆ°å·¥å…·åˆ—è¡¨
        toolsListEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
    });

    // å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K èšç„¦æœç´¢æ¡†
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
      // Escape æ¸…ç©ºæœç´¢
      if (e.key === 'Escape' && document.activeElement === searchInput) {
        searchInput.value = '';
        searchQuery = '';
        renderTools(filterTools());
        searchInput.blur();
      }
    });

    // æ·»åŠ æ·¡å…¥åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    `;
    document.head.appendChild(style);

    // åˆå§‹åŒ–
    initFuse();
  </script>
</Layout>
