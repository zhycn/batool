---
import HomeLayout from "../layouts/HomeLayout.astro";
import EmptyState from "../components/EmptyState.astro";
import Skeleton from "../components/Skeleton.astro";
import LoadingContainer from "../components/LoadingContainer.astro";
import type { Tool } from "../types/tool";
import { UI_CONFIG, SEARCH_CONFIG } from "../types/settings";

// åŠ è½½å·¥å…·æ•°æ®
const toolsData = await import("../../public/tools.json");
const tools: Tool[] = toolsData.default as Tool[];

// è·å–æ‰€æœ‰åˆ†ç±»å¹¶ç»Ÿè®¡
const categories = tools.reduce(
  (acc, tool) => {
    const cat = tool.category || "æœªåˆ†ç±»";
    acc[cat] = (acc[cat] || 0) + 1;
    return acc;
  },
  {} as Record<string, number>,
);

// æŒ‰å·¥å…·æ•°é‡æ’åºåˆ†ç±»
const categoryList = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<HomeLayout totalCount={tools.length} categoryList={categoryList}>
  <!-- ä¸»å†…å®¹åŒº -->
  <div class="w-full py-6">
    <!-- å·¥å…·åˆ—è¡¨ -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <EmptyState />
      <Skeleton />
      <!-- å·¥å…·åˆ—è¡¨ -->
      <div
        id="tools-list"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4"
      >
        <!-- ç”± JS åŠ¨æ€æ¸²æŸ“ -->
      </div>
      <LoadingContainer />
    </div>

    <!-- æœåŠ¡ç«¯æ•°æ®ä¼ é€’åˆ°å®¢æˆ·ç«¯ -->
    <script
      define:vars={{ tools, uiConfig: UI_CONFIG, searchConfig: SEARCH_CONFIG }}
    >
      window.__TOOLS__ = tools;
      window.__UI_CONFIG__ = uiConfig;
      window.__SEARCH_CONFIG__ = searchConfig;
    </script>

    <!-- å®¢æˆ·ç«¯è„šæœ¬ -->
    <script>
      import type Fuse from "fuse.js";
      import { debounce } from "../utils/debounce";

      // ä»å…¨å±€å˜é‡è·å–å·¥å…·æ•°æ®å’Œé…ç½®
      const toolsData = window.__TOOLS__;
      const uiConfig = window.__UI_CONFIG__;
      const searchConfig = window.__SEARCH_CONFIG__;

      console.log("ğŸ“¦ æ€»æ•°æ®é‡:", toolsData.length);

      // DOM å…ƒç´ 
      const searchInput = document.getElementById("search-input");
      const clearSearchBtn = document.getElementById("clear-search");
      const toolsListEl = document.getElementById("tools-list");
      const emptyStateEl = document.getElementById("empty-state");
      const skeletonStateEl = document.getElementById("skeleton-state");
      const loadingContainer = document.getElementById("loading-container");
      const loadingSentinel = document.getElementById("loading-sentinel");
      const loadingSpinner = document.getElementById("loading-spinner");
      const endMessage = document.getElementById("end-message");
      const totalCountEl = document.getElementById("total-count");
      const categoryButtons = document.querySelectorAll(".category-btn");

      // ç®€åŒ–çš„çŠ¶æ€
      let allTools: never[] = [];
      let filteredTools: string | any[] = [];
      let displayedCount = 0;
      let isLoading = false;
      let observer: IntersectionObserver | null = null;

      // æœç´¢å’Œç­›é€‰çŠ¶æ€
      let currentCategory = "all";
      let searchQuery = "";
      let fuse: string | Fuse<unknown> | null = null;

      // ä¸»é¢˜åˆ‡æ¢
      function initTheme() {
        const savedTheme =
          localStorage.getItem("theme") || uiConfig.DEFAULT_THEME;
        document.documentElement.setAttribute("data-theme", savedTheme);
      }

      function toggleTheme() {
        const currentTheme =
          document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";

        // é˜²æ­¢ä¸»é¢˜åˆ‡æ¢æ—¶çš„é—ªçƒ: ä¸´æ—¶ç¦ç”¨è¿‡æ¸¡åŠ¨ç”»
        const style = document.createElement("style");
        style.innerHTML = `
        *, *::before, *::after {
          transition: none !important;
        }
      `;
        document.head.appendChild(style);
        // å¼ºåˆ¶æµè§ˆå™¨é‡æ’
        document.documentElement.offsetHeight;

        // åˆ‡æ¢ä¸»é¢˜
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);

        // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿ä¸»é¢˜åˆ‡æ¢å®Œæˆåå†ç§»é™¤æ ·å¼
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            document.head.removeChild(style);
          });
        });
      }

      window.toggleTheme = toggleTheme;

      // åˆå§‹åŒ– Fuse.js
      async function initFuse() {
        const { default: Fuse } = await import("fuse.js");

        fuse = new Fuse(toolsData, {
          keys: [
            { name: "name", weight: searchConfig.FUSE_WEIGHTS.NAME },
            {
              name: "description",
              weight: searchConfig.FUSE_WEIGHTS.DESCRIPTION,
            },
            { name: "category", weight: searchConfig.FUSE_WEIGHTS.CATEGORY },
            { name: "tags", weight: searchConfig.FUSE_WEIGHTS.TAGS },
          ],
          threshold: searchConfig.FUSE_THRESHOLD,
          includeScore: false,
          shouldSort: true,
          minMatchCharLength: searchConfig.MIN_MATCH_CHAR_LENGTH,
          ignoreLocation: searchConfig.IGNORE_LOCATION,
        });

        allTools = toolsData;
        filteredTools = filterTools();
        console.log("ğŸ” ç­›é€‰åæ•°æ®é‡:", filteredTools.length);

        initObserver();
        loadNextPage();
      }

      // è¿‡æ»¤å·¥å…·
      function filterTools() {
        let filtered = allTools;

        if (currentCategory !== "all") {
          filtered = filtered.filter(
            (tool) => tool.category === currentCategory,
          );
        }

        if (searchQuery.trim() && fuse) {
          const results = fuse.search(searchQuery);
          filtered = filtered.filter((tool) =>
            results.some((r: { item: any }) => r.item === tool),
          );
        }

        return filtered;
      }

      // åˆå§‹åŒ– Observer
      function initObserver() {
        if (observer) {
          observer.disconnect();
        }

        observer = new IntersectionObserver(
          (entries) => {
            if (entries[0].isIntersecting && !isLoading) {
              loadNextPage();
            }
          },
          {
            rootMargin: uiConfig.OBSERVER.ROOT_MARGIN,
            threshold: uiConfig.OBSERVER.THRESHOLD,
          },
        );

        if (loadingSentinel) {
          observer.observe(loadingSentinel);
        }
      }

      // åŠ è½½ä¸‹ä¸€é¡µ
      function loadNextPage() {
        if (isLoading) {
          return;
        }

        if (displayedCount >= filteredTools.length) {
          showEndState();
          return;
        }

        isLoading = true;

        // éšè—éª¨æ¶å±
        if (skeletonStateEl) {
          skeletonStateEl.classList.add("hidden");
        }
        toolsListEl.classList.remove("hidden");

        const start = displayedCount;
        const end = Math.min(
          start + uiConfig.ITEMS_PER_PAGE,
          filteredTools.length,
        );
        const newItems = filteredTools.slice(start, end);

        renderToolButtons(newItems, displayedCount === 0);

        displayedCount = end;
        isLoading = false;

        if (displayedCount >= filteredTools.length) {
          showEndState();
          if (observer) observer.disconnect();
        }
      }

      // æ˜¾ç¤ºå·²åŠ è½½å…¨éƒ¨çŠ¶æ€
      function showEndState() {
        loadingSpinner.classList.add("hidden");

        // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä¸æ˜¾ç¤ºæ¶ˆæ¯
        if (displayedCount === 0) {
          endMessage.classList.add("hidden");
          return;
        }

        // å¦‚æœæ•°æ®é‡â‰¥é˜ˆå€¼ï¼Œæç¤ºç”¨æˆ·æœç´¢
        if (displayedCount >= uiConfig.LARGE_DATA_THRESHOLD) {
          endMessage.classList.remove("hidden");
          totalCountEl.innerHTML = `æ•°æ®è¾ƒå¤šï¼Œå»ºè®®ä½¿ç”¨æœç´¢åŠŸèƒ½ç²¾ç¡®å®šä½`;
          totalCountEl.parentElement.style.cursor = "pointer";
          totalCountEl.parentElement.onclick = () => {
            searchInput.focus();
            searchInput.select();
          };
        } else {
          // æ­£å¸¸æ˜¾ç¤º"å·²åŠ è½½å…¨éƒ¨"æ¶ˆæ¯
          endMessage.classList.remove("hidden");
          totalCountEl.textContent = `å·²åŠ è½½å…¨éƒ¨ ${displayedCount} æ¡æ•°æ®`;
          totalCountEl.parentElement.style.cursor = "default";
          totalCountEl.parentElement.onclick = null;
        }
      }

      // é‡ç½®åŠ è½½çŠ¶æ€
      function resetLoading() {
        displayedCount = 0;
        isLoading = false;

        toolsListEl.innerHTML = "";

        // å…ˆè¿‡æ»¤æ•°æ®
        filteredTools = filterTools();
        console.log("ğŸ”„ é‡ç½®åŠ è½½,ç­›é€‰å:", filteredTools.length, "æ¡");

        initObserver();

        // å¦‚æœç»“æœä¸ºç©ºï¼Œç›´æ¥æ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œä¸æ˜¾ç¤ºéª¨æ¶å±ï¼Œéšè—åŠ è½½å®¹å™¨
        if (filteredTools.length === 0) {
          if (skeletonStateEl) {
            skeletonStateEl.classList.add("hidden");
          }
          toolsListEl.classList.add("hidden");
          emptyStateEl.classList.remove("hidden");
          loadingContainer.classList.add("hidden"); // ç©ºçŠ¶æ€æ—¶éšè—åŠ è½½å®¹å™¨
        } else {
          // æœ‰æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºéª¨æ¶å±å¹¶å»¶è¿ŸåŠ è½½
          if (skeletonStateEl) {
            skeletonStateEl.classList.remove("hidden");
          }
          toolsListEl.classList.add("hidden");
          emptyStateEl.classList.add("hidden");
          loadingContainer.classList.remove("hidden"); // æ˜¾ç¤ºåŠ è½½å®¹å™¨ä»¥æ”¯æŒæ»šåŠ¨

          setTimeout(() => {
            loadNextPage();
          }, uiConfig.INITIAL_LOAD_DELAY);
        }
      }

      // æ¸²æŸ“å·¥å…·æŒ‰é’®ç½‘æ ¼ - æŒ‰é’®é£æ ¼
      function renderToolButtons(tools: any[], isFirstPage: boolean) {
        // éšè—éª¨æ¶å±
        if (skeletonStateEl) {
          skeletonStateEl.classList.add("hidden");
        }

        // ç©ºçŠ¶æ€å¤„ç†
        if (tools.length === 0) {
          toolsListEl.classList.add("hidden");
          emptyStateEl.classList.remove("hidden");
          return;
        }

        // æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨ï¼Œéšè—ç©ºçŠ¶æ€
        toolsListEl.classList.remove("hidden");
        emptyStateEl.classList.add("hidden");

        const fragment = document.createDocumentFragment();

        tools.forEach(
          (tool: { url: string; name: any; category: any }, index: number) => {
            const a = document.createElement("a");
            a.href = tool.url;
            a.target = "_blank";
            a.rel = "noopener noreferrer";

            // DaisyUI æŒ‰é’®æ ·å¼ + è‡ªå®šä¹‰æ ·å¼
            a.className =
              "btn btn-xl rounded-full flex items-center justify-between";

            // é¦–é¡µåŠ¨ç”»æ•ˆæœ
            if (isFirstPage) {
              a.style.opacity = "0";
              a.style.transform = `translateY(${uiConfig.ANIMATION.INITIAL_TRANSLATE_Y}px)`;
              a.style.transition = `opacity ${uiConfig.ANIMATION.FADE_IN_DURATION}ms ease-out ${index * uiConfig.ANIMATION.STAGGER_DELAY}ms, transform ${uiConfig.ANIMATION.FADE_IN_DURATION}ms ease-out ${index * uiConfig.ANIMATION.STAGGER_DELAY}ms`;
            }

            // æŒ‰é’®å†…å®¹ï¼šå·¥å…·åç§° + åˆ†ç±»æ ‡ç­¾ + å¤–éƒ¨é“¾æ¥å›¾æ ‡
            a.innerHTML = `
          <div class="flex-1 min-w-0 flex items-center gap-2 sm:gap-3">
            <span class="flex-shrink-0 text-base-content/30 hover:text-base-content/60 transition-colors">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 6H5.25A2.25 2.25 0 0 0 3 8.25v10.5A2.25 2.25 0 0 0 5.25 21h10.5A2.25 2.25 0 0 0 18 18.75V10.5m-10.5 6L21 3m0 0h-5.25M21 3v5.25" />
              </svg>
            </span>
            <span class="line-clamp-1 text-sm sm:text-base text-left font-medium text-base-content/90">
              ${tool.name}
            </span>
          </div>
          
          <div class="flex-1 min-w-0 flex items-center justify-end gap-3">
            <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-primary/10 text-primary whitespace-nowrap border border-primary/10">
                ${tool.category || "æœªåˆ†ç±»"}
              </span>
          </div>
        `;

            fragment.appendChild(a);
          },
        );

        toolsListEl.appendChild(fragment);

        // è§¦å‘åŠ¨ç”»
        if (isFirstPage) {
          requestAnimationFrame(() => {
            const items = toolsListEl.querySelectorAll("#tools-list > a");
            items.forEach((item) => {
              item.style.opacity = "1";
              item.style.transform = "translateY(0)";
            });
          });
        }
      }

      // æ›´æ–°åˆ†ç±»æŒ‰é’®çŠ¶æ€
      function updateCategoryButtons() {
        categoryButtons.forEach((btn) => {
          const category = btn.getAttribute("data-category");
          if (category === currentCategory) {
            btn.className =
              "category-btn px-4 py-2 rounded-full bg-primary text-primary-content text-sm font-medium hover:bg-primary/90 transition-all duration-200 whitespace-nowrap border border-transparent";
          } else {
            btn.className =
              "category-btn px-4 py-2 rounded-full bg-base-content/5 text-base-content/70 text-sm font-medium hover:bg-base-content/10 hover:text-base-content transition-all duration-200 border border-base-content/10 whitespace-nowrap";
          }
        });
      }

      // æœç´¢è¾“å…¥å¤„ç†
      searchInput.addEventListener(
        "input",
        debounce((e) => {
          const value = e.target.value;
          console.log("ğŸ” æœç´¢:", value);
          searchQuery = value;

          // æ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º
          if (value.length > 0) {
            clearSearchBtn.classList.remove("hidden");
          } else {
            clearSearchBtn.classList.add("hidden");
          }

          resetLoading();
        }, searchConfig.DEBOUNCE_DELAY),
      );

      // æ¸…é™¤æŒ‰é’®ç‚¹å‡»å¤„ç†
      clearSearchBtn.addEventListener("click", () => {
        searchInput.value = "";
        searchQuery = "";
        clearSearchBtn.classList.add("hidden");
        searchInput.focus();
        resetLoading();
      });

      // åˆ†ç±»æŒ‰é’®ç‚¹å‡»å¤„ç†
      categoryButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          console.log("ğŸ·ï¸  åˆ†ç±»:", btn.getAttribute("data-category"));
          currentCategory = btn.getAttribute("data-category") || "all";
          updateCategoryButtons();
          resetLoading();
        });
      });

      // å¿«æ·é”®æ”¯æŒ
      document.addEventListener("keydown", (e) => {
        // æœç´¢å¿«æ·é”® (âŒ˜K / Ctrl+K)
        if (
          uiConfig.SHORTCUTS.SEARCH.requiresMeta &&
          (e.metaKey || e.ctrlKey) &&
          e.key === uiConfig.SHORTCUTS.SEARCH.key
        ) {
          e.preventDefault();
          searchInput.focus();
          searchInput.select();
        }
        // Escape æ¸…é™¤æœç´¢
        if (
          e.key === uiConfig.SHORTCUTS.ESCAPE &&
          document.activeElement === searchInput
        ) {
          searchInput.value = "";
          searchQuery = "";
          clearSearchBtn.classList.add("hidden");
          resetLoading();
          searchInput.blur();
        }
      });

      // é¡µé¢å¸è½½æ—¶æ¸…ç†
      window.addEventListener("beforeunload", () => {
        if (observer) {
          observer.disconnect();
        }
      });

      // åˆå§‹åŒ–
      console.log("ğŸš€ å¼€å§‹åˆå§‹åŒ–...");
      initTheme();
      initFuse();
    </script>
  </div>
</HomeLayout>
