---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import type { Tool } from '../types/tool';

// åŠ è½½å·¥å…·æ•°æ®
const toolsData = await import('../../public/tools.json');
const tools: Tool[] = toolsData.default as Tool[];

// è·å–æ‰€æœ‰åˆ†ç±»å¹¶ç»Ÿè®¡
const categories = tools.reduce((acc, tool) => {
  const cat = tool.category || 'æœªåˆ†ç±»';
  acc[cat] = (acc[cat] || 0) + 1;
  return acc;
}, {} as Record<string, number>);

const categoryList = Object.entries(categories).sort((a, b) => b[1] - a[1]);
---

<Layout title="Batool - Tool Index">
  <div class="min-h-screen bg-base-100 flex flex-col">

    <Header />

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="flex-1 flex flex-col pt-14">

      <!-- Hero åŒºåŸŸ + æœç´¢æ¡† -->
      <div class="px-4 sm:px-6 pt-12 sm:pt-16 pb-8 sm:pb-12 text-center">
        <!-- æ ‡é¢˜ -->
        <h1 class="text-4xl sm:text-5xl md:text-6xl font-bold text-base-content tracking-tight mb-2 sm:mb-3">
          å·¥å…·å¿«é€Ÿç´¢å¼•
        </h1>
        <p class="text-base-content/50 text-sm sm:text-base md:text-lg mb-6 sm:mb-10">
          ç²¾é€‰å·¥å…· Â· æœç´¢å³è¾¾ Â· ç‚¹å‡»å³è¾¾
        </p>

        <!-- æœç´¢æ¡† - ç»Ÿä¸€å®½åº¦ max-w-4xl -->
        <div class="max-w-4xl mx-auto mb-8 sm:mb-12">
          <div class="relative">
            <input
              id="search-input"
              type="text"
              class="w-full px-4 sm:px-6 pr-24 sm:pr-28 py-3 sm:py-4 text-sm sm:text-base rounded-xl sm:rounded-2xl border-2 border-base-content/10 bg-base-100 focus:border-base-content/30 focus:outline-none transition-colors"
            />
            <div class="absolute right-3 sm:right-4 top-1/2 -translate-y-1/2 flex items-center gap-2">
              <!-- æ¸…é™¤æŒ‰é’® - æœ‰è¾“å…¥æ—¶æ˜¾ç¤º -->
              <button
                id="clear-search"
                type="button"
                class="hidden p-1.5 rounded-md hover:bg-base-content/5 text-base-content/40 hover:text-base-content/60 transition-colors"
                aria-label="æ¸…é™¤æœç´¢"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              <kbd class="hidden md:inline-flex px-2 py-1 text-xs font-medium text-base-content/40 bg-base-content/5 rounded-md">âŒ˜K</kbd>
            </div>
          </div>
        </div>

        <!-- åˆ†ç±»è¿‡æ»¤å™¨ - ç°ä»£æ ‡ç­¾æ ·å¼ -->
        <div class="flex flex-wrap justify-center gap-1.5 sm:gap-2">
          <button
            data-category="all"
            class="category-btn px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg bg-base-content text-base-100 text-xs sm:text-sm font-medium hover:opacity-90 transition-opacity"
          >
            å…¨éƒ¨ <span class="ml-1 sm:ml-1.5 opacity-60">({tools.length})</span>
          </button>
          {
            categoryList.map(([cat, count]) => (
              <button
                data-category={cat}
                class="category-btn px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg bg-base-content/5 text-base-content text-xs sm:text-sm font-medium hover:bg-base-content/10 transition-colors border border-base-content/5"
              >
                {cat} <span class="ml-1 sm:ml-1.5 opacity-40">({count})</span>
              </button>
            ))
          }
        </div>
      </div>

      <!-- å·¥å…·åˆ—è¡¨ - å¸¦å¤–æ¡†å®¹å™¨ -->
      <div class="flex-1 px-4 sm:px-6 pb-8 sm:pb-12">
        <div class="max-w-4xl mx-auto">
          <!-- ç»Ÿä¸€å¤–æ¡†å®¹å™¨ - å‚è€ƒ daisyUI menu ç»„ä»¶ -->
          <div class="menu rounded-xl border border-base-content/10 bg-base-100/50 w-full p-0">

            <!-- ç©ºçŠ¶æ€ -->
            <div id="empty-state" class="hidden text-center py-16 sm:py-20">
              <div class="text-5xl sm:text-6xl mb-4 sm:mb-6 opacity-20">ğŸ”</div>
              <h3 class="text-lg sm:text-xl font-semibold mb-2 sm:mb-3 text-base-content/50">æœªæ‰¾åˆ°åŒ¹é…çš„å·¥å…·</h3>
              <p class="text-base-content/30 text-sm">å°è¯•è°ƒæ•´æœç´¢è¯æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»</p>
            </div>

            <!-- éª¨æ¶å± -->
            <ul id="skeleton-state" class="hidden">
            {
              Array.from({ length: 5 }).map(() => (
                <li class="border-b border-base-content/5 last:border-b-0">
                  <div class="flex items-center justify-between gap-4 px-4 sm:px-6 py-3.5">
                    <div class="flex-1 min-w-0 space-y-2">
                      <div class="skeleton h-5 w-32 rounded"></div>
                      <div class="skeleton h-4 w-full max-w-md rounded"></div>
                    </div>
                    <div class="flex items-center gap-3 shrink-0">
                      <div class="skeleton h-7 w-16 rounded-md"></div>
                      <div class="skeleton h-4 w-4 rounded"></div>
                    </div>
                  </div>
                </li>
              ))
            }
            </ul>

          <!-- å·¥å…·åˆ—è¡¨ -->
          <ul id="tools-list" class="hidden">
            <!-- ç”± JS åŠ¨æ€æ¸²æŸ“ -->
          </ul>
          <!-- daisyUI menu ç»„ä»¶ç»“æŸ -->
        </div>

        <!-- åŠ è½½çŠ¶æ€ - ç§»åˆ° menu å®¹å™¨å¤–ï¼Œé¿å…è¢« overflow-hidden è£å‰ª -->
        <div id="loading-container" class="py-6 sm:py-8">
          <div id="loading-sentinel" class="min-h-[60px] flex items-center justify-center">
            <span id="loading-spinner" class="loading loading-spinner hidden"></span>
            <div id="end-message" class="hidden text-center text-base-content/30 text-sm cursor-pointer hover:text-base-content/50 transition-colors" title="ç‚¹å‡»èšç„¦æœç´¢æ¡†">
              <span id="total-count">å·²åŠ è½½å…¨éƒ¨ 0 æ¡æ•°æ®</span>
            </div>
          </div>
        </div>
      </div>

    </div>

    <Footer />

  </div>

  <!-- æœåŠ¡ç«¯æ•°æ®ä¼ é€’åˆ°å®¢æˆ·ç«¯ -->
  <script define:vars={{ tools }}>
    window.__TOOLS__ = tools;
  </script>

  <!-- å®¢æˆ·ç«¯è„šæœ¬ -->
  <script>
    // ä»å…¨å±€å˜é‡è·å–å·¥å…·æ•°æ®
    const toolsData = window.__TOOLS__ || [];
    console.log('ğŸ“¦ æ€»æ•°æ®é‡:', toolsData.length);

    // DOM å…ƒç´ 
    const searchInput = document.getElementById('search-input');
    const clearSearchBtn = document.getElementById('clear-search');
    const toolsListEl = document.getElementById('tools-list');
    const emptyStateEl = document.getElementById('empty-state');
    const skeletonStateEl = document.getElementById('skeleton-state');
    const loadingContainer = document.getElementById('loading-container');
    const loadingSentinel = document.getElementById('loading-sentinel');
    const loadingSpinner = document.getElementById('loading-spinner');
    const endMessage = document.getElementById('end-message');
    const totalCountEl = document.getElementById('total-count');
    const categoryButtons = document.querySelectorAll('.category-btn');

    // é…ç½®
    const ITEMS_PER_PAGE = 20;

    // ç®€åŒ–çš„çŠ¶æ€
    let allTools = [];
    let filteredTools = [];
    let displayedCount = 0;
    let isLoading = false;
    let observer = null;

    // æœç´¢å’Œç­›é€‰çŠ¶æ€
    let currentCategory = 'all';
    let searchQuery = '';
    let fuse = null;

    // ä¸»é¢˜åˆ‡æ¢
    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
    }

    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    window.toggleTheme = toggleTheme;

    // åˆå§‹åŒ– Fuse.js
    async function initFuse() {
      const { default: Fuse } = await import('fuse.js');

      fuse = new Fuse(toolsData, {
        keys: [
          { name: 'name', weight: 2 },
          { name: 'description', weight: 1.5 },
          { name: 'category', weight: 1 },
          { name: 'tags', weight: 1.2 }
        ],
        threshold: 0.4,
        includeScore: false,
        shouldSort: true,
        minMatchCharLength: 1,
        ignoreLocation: true
      });

      allTools = toolsData;
      filteredTools = filterTools();
      console.log('ğŸ” ç­›é€‰åæ•°æ®é‡:', filteredTools.length);

      initObserver();
      loadNextPage();
    }

    // è¿‡æ»¤å·¥å…·
    function filterTools() {
      let filtered = allTools;

      if (currentCategory !== 'all') {
        filtered = filtered.filter(tool => tool.category === currentCategory);
      }

      if (searchQuery.trim() && fuse) {
        const results = fuse.search(searchQuery);
        filtered = filtered.filter(tool =>
          results.some(r => r.item === tool)
        );
      }

      return filtered;
    }

    // åˆå§‹åŒ– Observer
    function initObserver() {
      if (observer) {
        observer.disconnect();
      }

      observer = new IntersectionObserver(
        (entries) => {
          if (entries[0].isIntersecting && !isLoading) {
            loadNextPage();
          }
        },
        {
          rootMargin: '100px',
          threshold: 0.1
        }
      );

      if (loadingSentinel) {
        observer.observe(loadingSentinel);
      }
    }

    // åŠ è½½ä¸‹ä¸€é¡µ
    function loadNextPage() {
      if (isLoading) {
        return;
      }

      if (displayedCount >= filteredTools.length) {
        showEndState();
        return;
      }

      isLoading = true;

      // éšè—éª¨æ¶å±
      if (skeletonStateEl) {
        skeletonStateEl.classList.add('hidden');
      }
      toolsListEl.classList.remove('hidden');

      const start = displayedCount;
      const end = Math.min(start + ITEMS_PER_PAGE, filteredTools.length);
      const newItems = filteredTools.slice(start, end);

      renderTools(newItems, displayedCount === 0);

      displayedCount = end;
      isLoading = false;

      if (displayedCount >= filteredTools.length) {
        showEndState();
        if (observer) observer.disconnect();
      }
    }

    // æ˜¾ç¤ºå·²åŠ è½½å…¨éƒ¨çŠ¶æ€
    function showEndState() {
      loadingSpinner.classList.add('hidden');

      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä¸æ˜¾ç¤ºæ¶ˆæ¯
      if (displayedCount === 0) {
        endMessage.classList.add('hidden');
        return;
      }

      // å¦‚æœæ•°æ®é‡â‰¥200ï¼Œæç¤ºç”¨æˆ·æœç´¢
      if (displayedCount >= 200) {
        endMessage.classList.remove('hidden');
        totalCountEl.innerHTML = `æ•°æ®è¿‡å¤šï¼Œå»ºè®®ä½¿ç”¨æœç´¢åŠŸèƒ½ç²¾ç¡®å®šä½`;
        totalCountEl.parentElement.style.cursor = 'pointer';
        totalCountEl.parentElement.onclick = () => {
          searchInput.focus();
          searchInput.select();
        };
      } else {
        // æ­£å¸¸æ˜¾ç¤º"å·²åŠ è½½å…¨éƒ¨"æ¶ˆæ¯
        endMessage.classList.remove('hidden');
        totalCountEl.textContent = `å·²åŠ è½½å…¨éƒ¨ ${displayedCount} æ¡æ•°æ®`;
        totalCountEl.parentElement.style.cursor = 'default';
        totalCountEl.parentElement.onclick = null;
      }
    }

    // é‡ç½®åŠ è½½çŠ¶æ€
    function resetLoading() {
      displayedCount = 0;
      isLoading = false;

      toolsListEl.innerHTML = '';

      // å…ˆè¿‡æ»¤æ•°æ®
      filteredTools = filterTools();
      console.log('ğŸ”„ é‡ç½®åŠ è½½,ç­›é€‰å:', filteredTools.length, 'æ¡');

      initObserver();

      // å¦‚æœç»“æœä¸ºç©ºï¼Œç›´æ¥æ˜¾ç¤ºç©ºçŠ¶æ€ï¼Œä¸æ˜¾ç¤ºéª¨æ¶å±ï¼Œéšè—åŠ è½½å®¹å™¨
      if (filteredTools.length === 0) {
        if (skeletonStateEl) {
          skeletonStateEl.classList.add('hidden');
        }
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        loadingContainer.classList.add('hidden');  // ç©ºçŠ¶æ€æ—¶éšè—åŠ è½½å®¹å™¨
      } else {
        // æœ‰æ•°æ®æ—¶ï¼Œæ˜¾ç¤ºéª¨æ¶å±å¹¶å»¶è¿ŸåŠ è½½
        if (skeletonStateEl) {
          skeletonStateEl.classList.remove('hidden');
        }
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.add('hidden');
        loadingContainer.classList.remove('hidden');  // æ˜¾ç¤ºåŠ è½½å®¹å™¨ä»¥æ”¯æŒæ»šåŠ¨

        setTimeout(() => {
          loadNextPage();
        }, 300);
      }
    }

    // æ¸²æŸ“å·¥å…·åˆ—è¡¨ - å‚è€ƒ daisyUI menu ç»„ä»¶
    function renderTools(tools, isFirstPage) {
      // éšè—éª¨æ¶å±
      if (skeletonStateEl) {
        skeletonStateEl.classList.add('hidden');
      }

      // ç©ºçŠ¶æ€å¤„ç†
      if (tools.length === 0) {
        toolsListEl.classList.add('hidden');
        emptyStateEl.classList.remove('hidden');
        return;
      }

      // æœ‰æ•°æ®æ—¶æ˜¾ç¤ºåˆ—è¡¨ï¼Œéšè—ç©ºçŠ¶æ€
      toolsListEl.classList.remove('hidden');
      emptyStateEl.classList.add('hidden');

      const fragment = document.createDocumentFragment();

      tools.forEach((tool, index) => {
        // ä½¿ç”¨ <li> ç¬¦åˆ daisyUI menu ç»“æ„
        const li = document.createElement('li');
        li.className = 'tool-item';

        const link = document.createElement('a');
        link.href = tool.url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        // ä½¿ç”¨ daisyUI çš„ menu æ ·å¼ + è‡ªå®šä¹‰ hover æ•ˆæœ
        link.className = 'flex items-center justify-between gap-3 sm:gap-4 px-4 sm:px-6 py-3 sm:py-3.5 rounded-lg hover:bg-base-content/5 active:bg-base-content/[0.08] transition-colors border-b border-base-content/5 last:border-b-0';

        if (isFirstPage) {
          link.style.opacity = '0';
          link.style.transform = 'translateY(8px)';
          link.style.transition = `opacity 0.2s ease-out ${index * 0.02}s, transform 0.2s ease-out ${index * 0.02}s`;
        }

        link.innerHTML = `
          <div class="flex items-center justify-between gap-3 sm:gap-4 w-full">
            <div class="flex-1 min-w-0">
              <div class="text-sm sm:text-base font-semibold text-base-content mb-0.5 truncate">
                ${tool.name}
              </div>
              <div class="text-xs sm:text-sm text-base-content/40 truncate hidden sm:block">
                ${tool.description}
              </div>
            </div>
            <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
              <span class="px-2 sm:px-2.5 py-1 rounded-md text-xs font-medium bg-base-content/5 text-base-content/50 whitespace-nowrap">
                ${tool.category || 'æœªåˆ†ç±»'}
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-base-content/20 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </div>
          </div>
        `;

        li.appendChild(link);
        fragment.appendChild(li);
      });

      toolsListEl.appendChild(fragment);

      if (isFirstPage) {
        requestAnimationFrame(() => {
          const items = toolsListEl.querySelectorAll('.tool-item a');
          items.forEach(item => {
            item.style.opacity = '1';
            item.style.transform = 'translateY(0)';
          });
        });
      }
    }

    // æ›´æ–°åˆ†ç±»æŒ‰é’®çŠ¶æ€
    function updateCategoryButtons() {
      categoryButtons.forEach(btn => {
        const category = btn.getAttribute('data-category');
        if (category === currentCategory) {
          btn.className = 'category-btn px-4 py-2 rounded-lg bg-base-content text-base-100 text-sm font-medium hover:opacity-90 transition-opacity';
        } else {
          btn.className = 'category-btn px-4 py-2 rounded-lg bg-base-content/5 text-base-content text-sm font-medium hover:bg-base-content/10 transition-colors border border-base-content/5';
        }
      });
    }

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // æœç´¢è¾“å…¥å¤„ç†
    searchInput.addEventListener('input', debounce((e) => {
      const value = e.target.value;
      console.log('ğŸ” æœç´¢:', value);
      searchQuery = value;

      // æ§åˆ¶æ¸…é™¤æŒ‰é’®æ˜¾ç¤º
      if (value.length > 0) {
        clearSearchBtn.classList.remove('hidden');
      } else {
        clearSearchBtn.classList.add('hidden');
      }

      resetLoading();
    }, 300));

    // æ¸…é™¤æŒ‰é’®ç‚¹å‡»å¤„ç†
    clearSearchBtn.addEventListener('click', () => {
      searchInput.value = '';
      searchQuery = '';
      clearSearchBtn.classList.add('hidden');
      searchInput.focus();
      resetLoading();
    });

    // åˆ†ç±»æŒ‰é’®ç‚¹å‡»å¤„ç†
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        console.log('ğŸ·ï¸  åˆ†ç±»:', btn.getAttribute('data-category'));
        currentCategory = btn.getAttribute('data-category') || 'all';
        updateCategoryButtons();
        resetLoading();
      });
    });

    // å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
        searchInput.select();
      }
      if (e.key === 'Escape' && document.activeElement === searchInput) {
        searchInput.value = '';
        searchQuery = '';
        clearSearchBtn.classList.add('hidden');
        resetLoading();
        searchInput.blur();
      }
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†
    window.addEventListener('beforeunload', () => {
      if (observer) {
        observer.disconnect();
      }
    });

    // åˆå§‹åŒ–
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–...');
    initTheme();
    initFuse();
  </script>
</Layout>
